rules_version = '2';

service cloud.firestore {
  match /databases/{database}/documents {

    // ============================================================
    // FUNCIONES AUXILIARES
    // ============================================================

    function isAuthenticated() {
      return request.auth != null;
    }

    // Admin check robusto: si el perfil no existe, retorna false sin error
    function isAdmin() {
      return isAuthenticated()
        && exists(/databases/$(database)/documents/users/$(request.auth.uid))
        && get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role == 'admin';
    }

    function isOwner(userId) {
      return isAuthenticated() && request.auth.uid == userId;
    }

    function isReasonableSize() {
      return request.resource.size < 65536;
    }

    function isGroupMember(groupId) {
      return isAuthenticated()
        && exists(/databases/$(database)/documents/groups/$(groupId)/members/$(request.auth.uid));
    }

    function isGroupCreator(groupId) {
      return isAuthenticated()
        && get(/databases/$(database)/documents/groups/$(groupId)).data.createdBy == request.auth.uid;
    }

    // ============================================================
    // COLECCIÓN: users/{userId}
    // ============================================================
    match /users/{userId} {
      allow read: if isAuthenticated();

      // Crear perfil: el propio usuario, campos mínimos requeridos
      allow create: if isOwner(userId)
                    && request.resource.data.uid == userId
                    && request.resource.data.email is string
                    && request.resource.data.displayName is string
                    && request.resource.data.role in ['admin', 'operator'];

      // Actualizar perfil: el propio usuario, no puede cambiar uid
      allow update: if isOwner(userId)
                    && request.resource.data.uid == resource.data.uid
                    && request.resource.data.role in ['admin', 'operator'];

      allow delete: if false;

      // ── tasks personales ──
      match /tasks/{taskId} {
        allow read: if isOwner(userId);
        allow create: if isOwner(userId)
                      && request.resource.data.title is string
                      && request.resource.data.title.size() > 0
                      && isReasonableSize();
        allow update: if isOwner(userId) && isReasonableSize();
        allow delete: if isOwner(userId);
      }

      // ── projects personales ──
      match /projects/{projectId} {
        allow read: if isOwner(userId);
        allow create: if isOwner(userId)
                      && request.resource.data.name is string
                      && request.resource.data.name.size() > 0
                      && isReasonableSize();
        allow update: if isOwner(userId) && isReasonableSize();
        allow delete: if isOwner(userId);
      }

      // ── preferences ──
      match /preferences/{prefId} {
        allow read:   if isOwner(userId);
        allow create: if isOwner(userId) && isReasonableSize();
        allow update: if isOwner(userId) && isReasonableSize();
        allow delete: if isOwner(userId);
      }
    }

    // ============================================================
    // COLECCIÓN: groups/{groupId}
    // ============================================================
    match /groups/{groupId} {
      allow read: if isAuthenticated();

      // Crear grupo: cualquier usuario autenticado con rol admin
      // Se removió keys().hasAll() para evitar rechazos por campos extras
      allow create: if isAuthenticated()
                    && request.resource.data.createdBy == request.auth.uid
                    && request.resource.data.name is string
                    && request.resource.data.name.size() > 0
                    && isReasonableSize();

      // Actualizar: solo el creador, no puede cambiar createdBy
      allow update: if isAuthenticated()
                    && resource.data.createdBy == request.auth.uid
                    && request.resource.data.createdBy == resource.data.createdBy
                    && isReasonableSize();

      // Eliminar: solo el creador
      allow delete: if isAuthenticated()
                    && resource.data.createdBy == request.auth.uid;

      // ── members ──
      match /members/{memberId} {
        allow read: if isAuthenticated();

        // Crear: un usuario se une a sí mismo, o el creador del grupo lo agrega
        allow create: if isAuthenticated()
                      && isReasonableSize()
                      && (
                        request.auth.uid == memberId
                        || get(/databases/$(database)/documents/groups/$(groupId)).data.createdBy == request.auth.uid
                      );

        // Actualizar: el creador del grupo o el propio miembro
        allow update: if isAuthenticated()
                      && isReasonableSize()
                      && (
                        get(/databases/$(database)/documents/groups/$(groupId)).data.createdBy == request.auth.uid
                        || request.auth.uid == memberId
                      );

        // Eliminar: el creador del grupo o el propio miembro
        allow delete: if isAuthenticated()
                      && (
                        get(/databases/$(database)/documents/groups/$(groupId)).data.createdBy == request.auth.uid
                        || request.auth.uid == memberId
                      );
      }

      // ── tasks del grupo ──
      match /tasks/{taskId} {
        allow read: if isGroupMember(groupId);
        allow create: if isGroupMember(groupId)
                      && request.resource.data.title is string
                      && request.resource.data.title.size() > 0
                      && isReasonableSize();
        allow update: if isGroupMember(groupId) && isReasonableSize();
        allow delete: if isGroupMember(groupId);
      }

      // ── projects del grupo ──
      match /projects/{projectId} {
        allow read: if isGroupMember(groupId);
        allow create: if isGroupMember(groupId)
                      && request.resource.data.name is string
                      && request.resource.data.name.size() > 0
                      && isReasonableSize();
        allow update: if isGroupMember(groupId) && isReasonableSize();
        allow delete: if isGroupMember(groupId);
      }
    }

    // ============================================================
    // COMPATIBILIDAD: colecciones raíz legacy
    // ============================================================
    match /tasks/{taskId} {
      allow read: if isAuthenticated();
      allow create: if isAuthenticated()
                    && request.resource.data.title is string
                    && request.resource.data.title.size() > 0
                    && isReasonableSize();
      allow update: if isAuthenticated() && isReasonableSize();
      allow delete: if isAuthenticated();
    }

    match /projects/{projectId} {
      allow read: if isAuthenticated();
      allow create: if isAuthenticated()
                    && request.resource.data.name is string
                    && request.resource.data.name.size() > 0
                    && isReasonableSize();
      allow update: if isAuthenticated() && isReasonableSize();
      allow delete: if isAuthenticated();
    }

    match /userPreferences/{userId} {
      allow read:   if isOwner(userId);
      allow create: if isOwner(userId) && isReasonableSize();
      allow update: if isOwner(userId) && isReasonableSize();
      allow delete: if isOwner(userId);
    }

    // ============================================================
    // DENEGAR TODO LO DEMÁS
    // ============================================================
  }
}
