rules_version = '2';

service cloud.firestore {
  match /databases/{database}/documents {

    // ============================================================
    // FUNCIONES AUXILIARES
    // ============================================================

    // Verificar que el usuario esté autenticado
    function isAuthenticated() {
      return request.auth != null;
    }

    // Verificar si el usuario es admin (con protección si el perfil no existe aún)
    function isAdmin() {
      return isAuthenticated()
        && exists(/databases/$(database)/documents/users/$(request.auth.uid))
        && get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role == 'admin';
    }

    // Verificar si el usuario es el dueño del documento
    function isOwner(userId) {
      return isAuthenticated() && request.auth.uid == userId;
    }

    // Verificar que el documento no exceda un tamaño razonable (64 KB)
    function isReasonableSize() {
      return request.resource.size < 65536;
    }

    // Verificar si el usuario es miembro de un grupo
    function isGroupMember(groupId) {
      return isAuthenticated()
        && exists(/databases/$(database)/documents/groups/$(groupId)/members/$(request.auth.uid));
    }

    // Verificar si el usuario es el creador del grupo
    function isGroupCreator(groupId) {
      return isAuthenticated()
        && exists(/databases/$(database)/documents/groups/$(groupId))
        && get(/databases/$(database)/documents/groups/$(groupId)).data.createdBy == request.auth.uid;
    }

    // ============================================================
    // COLECCIÓN: users/{userId}
    // Almacena perfiles de usuario (uid, email, displayName, role).
    //
    // ESTRUCTURA ANIDADA:
    //   users/{userId}/tasks/{taskId}       → tareas personales
    //   users/{userId}/projects/{projId}    → proyectos personales
    //   users/{userId}/preferences/main     → preferencias (tema, layout, dashboard)
    // ============================================================
    match /users/{userId} {
      // Cualquier usuario autenticado puede leer perfiles
      allow read: if isAuthenticated();

      // Solo el propio usuario puede crear su perfil (signup o auto-creación)
      allow create: if isOwner(userId)
                    && request.resource.data.uid == userId
                    && request.resource.data.email is string
                    && request.resource.data.displayName is string
                    && request.resource.data.role in ['admin', 'operator']
                    && request.resource.data.keys().hasAll(['uid', 'email', 'displayName', 'role']);

      // Solo el propio usuario puede actualizar su perfil
      allow update: if isOwner(userId)
                    && request.resource.data.uid == resource.data.uid
                    && request.resource.data.role in ['admin', 'operator'];

      // No se permite eliminar perfiles
      allow delete: if false;

      // ── SUBCOLECCIÓN: tasks (tareas personales del usuario) ──
      match /tasks/{taskId} {
        allow read: if isOwner(userId);

        allow create: if isOwner(userId)
                      && request.resource.data.createdBy == request.auth.uid
                      && request.resource.data.title is string
                      && request.resource.data.title.size() > 0
                      && isReasonableSize();

        allow update: if isOwner(userId)
                      && request.resource.data.createdBy == resource.data.createdBy
                      && isReasonableSize();

        allow delete: if isOwner(userId);
      }

      // ── SUBCOLECCIÓN: projects (proyectos personales del usuario) ──
      match /projects/{projectId} {
        allow read: if isOwner(userId);

        allow create: if isOwner(userId)
                      && request.resource.data.createdBy == request.auth.uid
                      && request.resource.data.name is string
                      && request.resource.data.name.size() > 0
                      && isReasonableSize();

        allow update: if isOwner(userId)
                      && request.resource.data.createdBy == resource.data.createdBy
                      && isReasonableSize();

        allow delete: if isOwner(userId);
      }

      // ── SUBCOLECCIÓN: preferences (configuración del usuario) ──
      match /preferences/{prefId} {
        allow read:   if isOwner(userId);
        allow create: if isOwner(userId) && isReasonableSize();
        allow update: if isOwner(userId) && isReasonableSize();
        allow delete: if isOwner(userId);
      }
    }

    // ============================================================
    // COLECCIÓN: groups/{groupId}
    // Almacena grupos/empresas.
    //
    // ESTRUCTURA ANIDADA:
    //   groups/{groupId}/members/{memberId}  → miembros del grupo
    //   groups/{groupId}/tasks/{taskId}      → tareas del grupo
    //   groups/{groupId}/projects/{projId}   → proyectos del grupo
    // ============================================================
    match /groups/{groupId} {
      allow read: if isAuthenticated();

      allow create: if isAdmin()
                    && request.resource.data.createdBy == request.auth.uid
                    && request.resource.data.name is string
                    && request.resource.data.name.size() > 0
                    && request.resource.data.keys().hasAll(['name', 'createdBy', 'createdAt', 'inviteCode'])
                    && isReasonableSize();

      allow update: if isAuthenticated()
                    && resource.data.createdBy == request.auth.uid
                    && request.resource.data.createdBy == resource.data.createdBy
                    && isReasonableSize();

      allow delete: if isAuthenticated()
                    && resource.data.createdBy == request.auth.uid;

      // ── SUBCOLECCIÓN: members ──────────────────────────────
      match /members/{memberId} {
        allow read: if isAuthenticated();

        allow create: if isAuthenticated()
                      && request.resource.data.uid is string
                      && request.resource.data.displayName is string
                      && isReasonableSize()
                      && (
                        request.auth.uid == memberId
                        || get(/databases/$(database)/documents/groups/$(groupId)).data.createdBy == request.auth.uid
                      );

        allow update: if isAuthenticated()
                      && request.resource.data.uid == resource.data.uid
                      && isReasonableSize()
                      && (
                        get(/databases/$(database)/documents/groups/$(groupId)).data.createdBy == request.auth.uid
                        || request.auth.uid == memberId
                      );

        allow delete: if isAuthenticated()
                      && (
                        get(/databases/$(database)/documents/groups/$(groupId)).data.createdBy == request.auth.uid
                        || request.auth.uid == memberId
                      );
      }

      // ── SUBCOLECCIÓN: tasks (tareas del grupo) ─────────────
      match /tasks/{taskId} {
        allow read: if isGroupMember(groupId);

        allow create: if isGroupMember(groupId)
                      && request.resource.data.createdBy == request.auth.uid
                      && request.resource.data.title is string
                      && request.resource.data.title.size() > 0
                      && isReasonableSize();

        allow update: if isGroupMember(groupId)
                      && request.resource.data.createdBy == resource.data.createdBy
                      && isReasonableSize()
                      && (
                        isGroupCreator(groupId)
                        || resource.data.createdBy == request.auth.uid
                        || resource.data.assignedTo == request.auth.uid
                      );

        allow delete: if isGroupMember(groupId)
                      && (
                        isGroupCreator(groupId)
                        || resource.data.createdBy == request.auth.uid
                      );
      }

      // ── SUBCOLECCIÓN: projects (proyectos del grupo) ───────
      match /projects/{projectId} {
        allow read: if isGroupMember(groupId);

        allow create: if isGroupMember(groupId)
                      && request.resource.data.createdBy == request.auth.uid
                      && request.resource.data.name is string
                      && request.resource.data.name.size() > 0
                      && isReasonableSize();

        allow update: if isGroupMember(groupId)
                      && request.resource.data.createdBy == resource.data.createdBy
                      && isReasonableSize()
                      && (
                        isGroupCreator(groupId)
                        || resource.data.createdBy == request.auth.uid
                      );

        allow delete: if isGroupMember(groupId)
                      && (
                        isGroupCreator(groupId)
                        || resource.data.createdBy == request.auth.uid
                      );
      }
    }

    // ============================================================
    // COMPATIBILIDAD: colecciones raíz legacy
    // (se pueden eliminar tras migrar datos existentes)
    // ============================================================
    match /tasks/{taskId} {
      allow read: if isAuthenticated();
      allow create: if isAuthenticated()
                    && request.resource.data.createdBy == request.auth.uid
                    && request.resource.data.title is string
                    && request.resource.data.title.size() > 0
                    && isReasonableSize();
      allow update: if isAuthenticated()
                    && request.resource.data.createdBy == resource.data.createdBy
                    && isReasonableSize()
                    && (
                      isAdmin()
                      || resource.data.createdBy == request.auth.uid
                      || resource.data.assignedTo == request.auth.uid
                    );
      allow delete: if isAuthenticated()
                    && (
                      isAdmin()
                      || resource.data.createdBy == request.auth.uid
                    );
    }

    match /projects/{projectId} {
      allow read: if isAuthenticated();
      allow create: if isAuthenticated()
                    && request.resource.data.createdBy == request.auth.uid
                    && request.resource.data.name is string
                    && request.resource.data.name.size() > 0
                    && isReasonableSize();
      allow update: if isAuthenticated()
                    && request.resource.data.createdBy == resource.data.createdBy
                    && isReasonableSize()
                    && (
                      isAdmin()
                      || resource.data.createdBy == request.auth.uid
                    );
      allow delete: if isAuthenticated()
                    && (
                      isAdmin()
                      || resource.data.createdBy == request.auth.uid
                    );
    }

    match /userPreferences/{userId} {
      allow read:   if isOwner(userId);
      allow create: if isOwner(userId) && isReasonableSize();
      allow update: if isOwner(userId) && isReasonableSize();
      allow delete: if isOwner(userId);
    }

    // ============================================================
    // DENEGAR TODO LO DEMÁS
    // ============================================================
  }
}
